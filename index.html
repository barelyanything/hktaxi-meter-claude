<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#111111">
  <link rel="manifest" href="manifest.json">
  <title>HK Taxi Meter</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    @font-face {
      font-family: 'DSEG7';
      src: url('https://cdn.jsdelivr.net/npm/dseg@0.46.0/fonts/DSEG7-Classic/DSEG7Classic-Bold.woff2') format('woff2'),
           url('https://cdn.jsdelivr.net/npm/dseg@0.46.0/fonts/DSEG7-Classic/DSEG7Classic-Bold.woff') format('woff');
      font-weight: bold;
      font-style: normal;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      touch-action: manipulation;
      height: 100%;
      overflow: hidden;
    }

    body {
      background: #1a1a1a;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      min-height: 100dvh;
      overflow: hidden;
      font-family: Arial, Helvetica, sans-serif;
    }

    .meter {
      background: #111;
      border: 3px solid #333;
      border-radius: 8px;
      width: fit-content;
      padding: 0;
      box-shadow: 0 4px 20px rgba(0,0,0,0.8), inset 0 1px 0 rgba(255,255,255,0.05);
      overflow: hidden;
    }

    /* Top display area */
    .display-area {
      background: #0a0a0a;
      border: 2px solid #222;
      margin: 12px 12px 0 12px;
      padding: 10px 14px 0;
      position: relative;
    }

    .display-row {
      display: flex;
      align-items: stretch;
      gap: 0;
    }

    .fare-section, .extras-section {
      flex: 1;
      position: relative;
      border: 1.5px solid #555;
      padding: 8px 0 14px 10px;
    }

    .fare-section {
      margin-right: 2px;
    }

    .section-label {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      background: #0a0a0a;
      padding: 0 10px;
      color: #ccc;
      font-size: 14px;
      font-weight: bold;
      letter-spacing: 4px;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .brand-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4px 6px 4px 20px;
      color: #888;
      font-size: 10px;
      line-height: 1.3;
      text-align: center;
    }

    .brand-area .brand-logo {
      font-size: 14px;
      font-weight: bold;
      color: #aaa;
      border: 1px solid #888;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 2px;
    }

    .brand-area .brand-name {
      font-weight: bold;
      font-size: 12px;
      color: #aaa;
    }

    .brand-area .brand-model {
      font-size: 10px;
      color: #777;
    }

    .digit-display {
      position: relative;
      min-height: 48px;
      display: flex;
      align-items: flex-end;
      justify-content: flex-end;
    }

    .digit-main, .digit-decimal {
      position: relative;
    }

    .digit-decimal {
      border-left: 1.5px solid #555;
      margin-left: 5px;
      padding-left: 1px;
    }

    .seven-seg, .seven-seg-bg {
      font-family: 'DSEG7', monospace;
      font-size: clamp(46px, 11.4vw, 76px);
      letter-spacing: 2px;
      line-height: 1;
    }

    .digit-main .seven-seg-bg, .digit-decimal .seven-seg-bg {
      position: absolute;
      right: 0;
      bottom: 0;
    }

    .seven-seg {
      color: #ff1a1a;
      text-shadow: 0 0 12px rgba(255, 20, 20, 0.6), 0 0 24px rgba(255, 20, 20, 0.3);
    }

    .seven-seg-bg {
      color: rgba(255, 20, 20, 0.07);
    }

    .currency-label {
      position: absolute;
      bottom: -9px;
      left: 10px;
      background: #0a0a0a;
      padding: 0 4px;
      color: #ccc;
      font-size: 14px;
      font-weight: bold;
    }

    .unit-label {
      position: absolute;
      bottom: -9px;
      right: 10px;
      background: #0a0a0a;
      padding: 0 4px;
      color: #ccc;
      font-size: 14px;
      font-weight: bold;
    }

    .status-row {
      display: flex;
      margin: 6px 0;
      justify-content: center;
      align-items: center;
      padding: 0 8px;
    }

    .status-cell {
      width: 80px;
      margin: 0 12px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 18px;
    }

    .status-text {
      font-family: 'Arial Narrow', 'Helvetica Neue', sans-serif;
      font-stretch: condensed;
      font-size: 16px;
      font-weight: bold;
      color: transparent;
      text-transform: uppercase;
      letter-spacing: 0;
    }

    .status-text.active {
      color: #ff1a1a;
      text-shadow: 0 0 12px rgba(255, 20, 20, 0.6), 0 0 24px rgba(255, 20, 20, 0.3);
    }

    .mileage-indicator {
      width: 28px;
      height: 14px;
      background: #332200;
      border-radius: 1px;
    }

    .mileage-indicator.active {
      background: #ffaa00;
      box-shadow: 0 0 6px rgba(255, 170, 0, 0.6);
    }

    /* Bottom control panel */
    .control-panel {
      background: #1a1a1a;
      border-top: 2px solid #222;
      margin: 4px 12px 6px;
      padding: 10px 12px;
      display: flex;
      gap: 0;
      justify-content: center;
      align-items: flex-end;
      position: relative;
    }


    .meter-btn {
      width: 80px;
      height: 40px;
      border: 1px solid #222;
      border-radius: 4px;
      cursor: pointer;
      position: relative;
      margin: 0 12px;
      outline: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.1);
      transition: transform 0.05s, box-shadow 0.05s;
    }

    .meter-btn:active {
      transform: translateY(1px);
      box-shadow: 0 1px 2px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.05);
    }

    .btn-red {
      background: linear-gradient(180deg, #cc3333 0%, #991111 100%);
    }

    .btn-yellow {
      background: linear-gradient(180deg, #ccaa33 0%, #998811 100%);
    }

    .btn-orange {
      background: linear-gradient(180deg, #cc7733 0%, #995511 100%);
    }

    .btn-label {
      font-size: 16px;
      color: #999;
      text-align: center;
      margin-bottom: 4px;
      white-space: nowrap;
      height: 18px;
      line-height: 18px;
    }

    .btn-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* GPS status */
    .gps-status {
      font-size: 9px;
      color: #555;
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .gps-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: #333;
    }

    .gps-dot.active {
      background: #00cc44;
      box-shadow: 0 0 4px rgba(0, 204, 68, 0.5);
    }

    .gps-dot.error {
      background: #cc3333;
    }

    /* Distance info at bottom */
    .debug-info {
      margin: 0 12px 8px;
      padding: 4px 8px;
      font-size: 9px;
      color: #444;
      display: flex;
      justify-content: space-between;
    }

    /* Portrait phone */
    @media (max-width: 560px) and (orientation: portrait) {
      .meter {
        width: 100vw;
        border-radius: 0;
        border-left: none;
        border-right: none;
      }
    }

    /* Landscape phone — full bleed, no chrome */
    @media (max-height: 500px) and (orientation: landscape) {
      html, body {
        height: 100%;
        overflow: hidden;
      }

      body {
        align-items: stretch;
      }

      .meter {
        width: 100vw;
        height: 100vh;
        height: 100dvh;
        border: none;
        border-radius: 0;
        box-shadow: none;
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
      }

      .display-row {
        width: 100%;
      }

      .fare-section, .extras-section {
        padding: 12px 0 16px 16px;
      }

      .debug-info {
        margin: 0 16px 6px;
        padding: 4px 12px;
        font-size: 11px;
      }

      .gps-status {
        font-size: 11px;
      }

      .gps-dot {
        width: 7px;
        height: 7px;
      }
    }
    /* === Receipt Printer Overlay === */
    .printer-overlay {
      position: fixed;
      inset: 0;
      z-index: 1000;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 0;
      overflow: visible;
    }
    .printer-overlay.hidden { display: none; }

    .printer-overlay-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.88);
      transition: opacity 0.5s ease;
    }

    .printer-overlay-backdrop.fading {
      opacity: 0;
    }

    .printer-scene {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow: visible;
      perspective: 900px;
      /* Slide in from below */
      transform: translateY(100%);
      transition: transform 0.5s cubic-bezier(0.22, 1, 0.36, 1);
    }

    .printer-scene.entered {
      transform: translateY(0);
    }

    .printer-scene.printer-exit {
      transform: translateY(calc(100% + 40px));
      transition: transform 0.6s cubic-bezier(0.55, 0, 1, 0.45);
    }

    /* Paper track sits ABOVE the printer */
    .printer-paper-track {
      width: 250px;
      position: relative;
      z-index: 1;
      max-height: 0;
      transform-style: preserve-3d;
      top: 50px;
    }

    .printer-paper-track.printing {
      /* max-height driven by JS dot-matrix stepper */
    }

    .receipt-paper {
      background: #f5f0e8;
      width: 250px;
      padding: 0;
      position: relative;
      cursor: default;
      /* Front face points to user's right (89deg — nearly edge-on) */
      transform: rotateY(89deg);
      transform-origin: center bottom;
      transition: transform 0.8s cubic-bezier(0.25, 0.1, 0.25, 1);
    }

    .receipt-paper.presented {
      /* Detach from printer, move to center of screen, swing to face user */
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) rotateY(0deg);
      transform-origin: center center;
      z-index: 1010;
      cursor: grab;
      box-shadow: 0 8px 40px rgba(0,0,0,0.5);
      /* Match receipt-final styling */
      width: auto;
      max-width: 360px;
      max-height: 70vh;
      overflow-y: auto;
    }

    .receipt-paper.presented .receipt-content {
      font-size: 12px;
      padding: 60px 14px;
      text-align: center;
    }

    .receipt-paper.presented .receipt-tear-edge {
      display: none;
    }

    .receipt-paper:active { cursor: grabbing; }

    /* Visible paper edge — the thickness of the receipt roll paper */
    .receipt-paper::after {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      right: -2px;
      width: 2px;
      background: linear-gradient(180deg, #ede8df, #d5d0c7, #ede8df);
      transform: rotateY(-90deg);
      transform-origin: left center;
    }

    .receipt-content {
      font-family: 'Courier New', 'Courier', monospace;
      font-size: 10px;
      line-height: 1.55;
      color: #1a3a6a;
      white-space: pre;
      padding: 40px 10px 40px;
    }

    .receipt-tear-edge {
      height: 10px;
      width: 100%;
      background: #f5f0e8;
      clip-path: polygon(
        0% 0%, 2.5% 100%, 5% 0%, 7.5% 100%, 10% 0%, 12.5% 100%,
        15% 0%, 17.5% 100%, 20% 0%, 22.5% 100%, 25% 0%, 27.5% 100%,
        30% 0%, 32.5% 100%, 35% 0%, 37.5% 100%, 40% 0%, 42.5% 100%,
        45% 0%, 47.5% 100%, 50% 0%, 52.5% 100%, 55% 0%, 57.5% 100%,
        60% 0%, 62.5% 100%, 65% 0%, 67.5% 100%, 70% 0%, 72.5% 100%,
        75% 0%, 77.5% 100%, 80% 0%, 82.5% 100%, 85% 0%, 87.5% 100%,
        90% 0%, 92.5% 100%, 95% 0%, 97.5% 100%, 100% 0%
      );
    }

    .receipt-paper.tearing {
      animation: tear-away 0.4s ease-in forwards;
    }

    @keyframes tear-away {
      0%   { transform: translateX(0) rotate(0deg); opacity: 1; }
      100% { transform: translateX(300px) rotate(8deg); opacity: 0; }
    }

    /* Printer body — SVG printer image */
    .printer-body {
      width: 384px;
      position: relative;
      z-index: 2;
      margin-top: -3px; /* overlap paper track into slot */
    }

    .printer-body img {
      width: 100%;
      height: auto;
      display: block;
    }

    /* Printer label — attached to printer body */
    .printer-label {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #ccc;
      padding: 6px;
      text-align: center;
      border-radius: 4px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.15);
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3;
    }

    .printer-label-left {
      font-size: 28px;
      font-weight: 900;
      color: #cc2222;
      line-height: 1;
      white-space: nowrap;
    }

    .printer-label-right {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .printer-label-title {
      font-size: 13px;
      font-weight: 700;
      color: #cc2222;
      white-space: nowrap;
      line-height: 1.3;
    }

    .printer-label-phone {
      font-size: 12px;
      font-weight: 600;
      color: #1a3a8a;
      white-space: nowrap;
      line-height: 1.3;
    }

    .printer-label-phone i {
      font-size: 10px;
      margin-right: 2px;
    }



    /* Responsive: portrait phone */
    @media (max-width: 560px) and (orientation: portrait) {
      .printer-body { width: 324px; }
      .printer-paper-track { width: 224px; }
    }

  </style>
</head>
<body>
  <div class="meter">
    <div class="display-area">
      <div class="display-row">
        <div class="fare-section">
          <div class="section-label">F A R E</div>
          <div class="digit-display">
            <div class="digit-main">
              <span class="seven-seg-bg">888.</span>
              <span class="seven-seg" id="fare-main">0.</span>
            </div>
            <div class="digit-decimal">
              <span class="seven-seg-bg">8</span>
              <span class="seven-seg" id="fare-dec">0</span>
            </div>
          </div>
          <div class="currency-label">HK$</div>
          <div class="unit-label">C(x10)</div>
        </div>
        <div class="extras-section">
          <div class="section-label">EXTRAS</div>
          <div class="digit-display">
            <div class="digit-main">
              <span class="seven-seg-bg">888.</span>
              <span class="seven-seg" id="extras-main">0.</span>
            </div>
            <div class="digit-decimal">
              <span class="seven-seg-bg">8</span>
              <span class="seven-seg" id="extras-dec">0</span>
            </div>
          </div>
          <div class="currency-label">HK$</div>
          <div class="unit-label">C(x10)</div>
        </div>
        <div class="brand-area">
          <div class="brand-logo">D</div>
          <div class="brand-name">DLLM</div>
          <div class="brand-model">DLM 667</div>
          <div class="brand-model">P K</div>
        </div>
      </div>
      <div class="status-row">
        <div class="status-cell"><span class="status-text" id="status-vacant">VACANT</span></div>
        <div class="status-cell"><span class="status-text" id="status-hired">HIRED</span></div>
        <div class="status-cell"><span class="status-text" id="status-stop">STOP</span></div>
        <div class="status-cell status-cell-lang"><span class="status-text status-lang" id="status-lang-en">英</span><span class="status-text status-lang" id="status-lang-yue">粵</span></div>
        <div class="status-cell" style="margin-left: 16px;"><div class="mileage-indicator" id="mileage-indicator"></div></div>
        <div class="status-cell"></div>
      </div>
    </div>

    <div class="control-panel">
      <div class="btn-wrapper">
        <div class="btn-label">空</div>
        <button class="meter-btn btn-red" id="btn-forhire" title="For Hire"></button>
      </div>
      <div class="btn-wrapper">
        <div class="btn-label">往</div>
        <button class="meter-btn btn-yellow" id="btn-hired" title="Hired"></button>
      </div>
      <div class="btn-wrapper">
        <div class="btn-label">停/講/印</div>
        <button class="meter-btn btn-yellow" id="btn-pause" title="Pause"></button>
      </div>
      <div class="btn-wrapper">
        <div class="btn-label">語</div>
        <button class="meter-btn btn-yellow" id="btn-lang" title="Language"></button>
      </div>
      <div class="btn-wrapper" style="margin-left: 16px;">
        <div class="btn-label">附加 $10.</div>
        <button class="meter-btn btn-yellow" id="btn-add10" title="Add $10 Extra"></button>
      </div>
      <div class="btn-wrapper">
        <div class="btn-label">$1.</div>
        <button class="meter-btn btn-yellow" id="btn-add1" title="Add $1 Extra"></button>
      </div>
    </div>

    <div class="debug-info">
      <span class="gps-status">
        <span class="gps-dot" id="gps-dot"></span>
        <span id="gps-text">GPS</span>
      </span>
      <span id="distance-info">0.000 km</span>
      <span id="time-info">00:00</span>
    </div>
  </div>

  <!-- Printer Overlay -->
  <div id="printer-overlay" class="printer-overlay hidden">
    <div class="printer-overlay-backdrop"></div>
    <div class="printer-scene">
      <div class="printer-paper-track">
        <div id="receipt-paper" class="receipt-paper">
          <div id="receipt-content" class="receipt-content"></div>
          <div class="receipt-tear-edge"></div>
        </div>
      </div>
      <div class="printer-body">
        <div class="printer-label">
          <div class="printer-label-left">我吉你</div>
          <div class="printer-label-right">
            <div class="printer-label-title">的士咪錶收條打印機</div>
            <div class="printer-label-phone"><i class="fa-solid fa-phone-flip"></i> 2233 4455</div>
          </div>
        </div>
        <img src="printer.svg" alt="Printer">
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    // === Beep ===
    const beepSound = new Audio('beep-2.mp3');
    beepSound.volume = 0.1;
    function beep() {
      beepSound.currentTime = 0;
      beepSound.play();
      speechSynthesis.cancel();
    }

    // === Print Sound ===
    const printSound = new Audio('print.mp3');
    printSound.volume = 0.2;
    printSound.loop = true;

    // === Tear Sound ===
    const tearSound = new Audio('tear.mp3');
    tearSound.volume = 0.5;

    // === TTS ===
    let ttsLang = 'off'; // 'off', 'yue' for Cantonese, 'en' for English

    function speakText(text, lang) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = lang;
      speechSynthesis.cancel();
      speechSynthesis.speak(utterance);
    }

    function speakFare() {
      const total = Math.round((state.fare + state.extras) * 10) / 10;
      const dollars = Math.floor(total);
      const cents = Math.round((total - dollars) * 10); // tenths = 角/dime

      let text, lang;
      if (ttsLang === 'yue') {
        text = '現在車費是' + dollars + '元';
        if (cents > 0) text += cents + '角';
        lang = 'zh-HK';
      } else {
        text = 'The current fare is ' + dollars + ' dollar' + (dollars !== 1 ? 's' : '');
        if (cents > 0) text += ' and ' + (cents * 10) + ' cent' + (cents * 10 !== 1 ? 's' : '');
        lang = 'en-US';
      }

      speakText(text, lang);
    }

    // === Mileage indicator blink ===
    function blinkMileageIndicator() {
      const el = document.getElementById('mileage-indicator');
      el.classList.remove('active');
      setTimeout(() => {
        if (state.running) el.classList.add('active');
      }, 200);
    }

    function onFareTick() {
      beep();
      blinkMileageIndicator();
    }

    // === State ===
    const state = {
      running: false,
      paused: false,   // true when trip is paused (not reset)
      fare: 0,        // in HK$ (cents precision internally)
      extras: 0,       // in HK$
      totalExtras: 0,  // cumulative extras for receipt (not reset by merge)
      distanceM: 0,    // meters traveled
      stationaryMs: 0, // milliseconds stationary
      distanceSinceLastTick: 0, // meters since last fare increment
      stationarySinceLastTick: 0, // ms since last stationary tick
      lastPosition: null,
      lastTimestamp: null,
      watchId: null,
      timerInterval: null,
      startTime: null,
      elapsedBeforePause: 0,
      gpsAvailable: false,
      isMoving: false,
      speedThreshold: 0.5, // m/s — below this we consider stationary
    };

    // === Fare rules ===
    const STARTING_FARE = 29.0;
    const STARTING_DISTANCE = 2000;  // meters included in starting fare
    const DISTANCE_INCREMENT = 200;  // meters per fare tick after starting distance
    const TIME_INCREMENT = 60000;    // 1 minute in ms
    const FARE_PER_INCREMENT = 2.1;

    // === LocalStorage keys ===
    const STORAGE_KEY_RIDE = 'hktaxi_current_ride';
    const STORAGE_KEY_LOG = 'hktaxi_fare_log'; // for future fare history

    // === Persistence ===
    function saveRide() {
      try {
        const elapsed = state.running
          ? state.elapsedBeforePause + (Date.now() - state.startTime)
          : state.elapsedBeforePause;
        const data = {
          fare: state.fare,
          extras: state.extras,
          totalExtras: state.totalExtras,
          distanceM: state.distanceM,
          stationaryMs: state.stationaryMs,
          distanceSinceLastTick: state.distanceSinceLastTick,
          stationarySinceLastTick: state.stationarySinceLastTick,
          elapsedMs: elapsed,
          wasRunning: state.running,
          savedAt: Date.now(),
        };
        localStorage.setItem(STORAGE_KEY_RIDE, JSON.stringify(data));
      } catch (e) {
        // Storage full or unavailable — silently ignore
      }
    }

    function loadRide() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_RIDE);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (e) {
        return null;
      }
    }

    function clearSavedRide() {
      try { localStorage.removeItem(STORAGE_KEY_RIDE); } catch (e) {}
    }

    // === DOM refs ===
    const fareMain = document.getElementById('fare-main');
    const fareDec = document.getElementById('fare-dec');
    const extrasMain = document.getElementById('extras-main');
    const extrasDec = document.getElementById('extras-dec');
    const mileageIndicator = document.getElementById('mileage-indicator');
    const statusVacant = document.getElementById('status-vacant');
    const statusHired = document.getElementById('status-hired');
    const statusStop = document.getElementById('status-stop');
    const statusLangEn = document.getElementById('status-lang-en');
    const statusLangYue = document.getElementById('status-lang-yue');
    // langIndicatorState removed — ttsLang ('off'/'yue'/'en') drives indicators directly
    const gpsDot = document.getElementById('gps-dot');
    const gpsText = document.getElementById('gps-text');
    const distanceInfo = document.getElementById('distance-info');
    const timeInfo = document.getElementById('time-info');

    // === Display formatting ===
    function formatFare(amount) {
      const rounded = Math.round(amount * 10) / 10;
      const str = rounded.toFixed(1);
      const dotIdx = str.indexOf('.');
      return {
        main: str.substring(0, dotIdx + 1),  // e.g. "29."
        dec: str.substring(dotIdx + 1),       // e.g. "0"
      };
    }

    function updateStatusIndicators() {
      const isVacant = !state.running && !state.paused;
      const isHired = state.running;
      const isStop = !state.running && state.paused;

      statusVacant.classList.toggle('active', isVacant);
      statusHired.classList.toggle('active', isHired);
      statusStop.classList.toggle('active', isStop);
    }

    function setDigitVisibility(el, visible) {
      el.style.visibility = visible ? 'visible' : 'hidden';
    }

    function updateDisplay() {
      const isVacant = !state.running && !state.paused;

      if (isVacant && state.fare === 0) {
        // Hide digits when vacant (keep layout via seven-seg text)
        fareMain.textContent = '0.';
        fareDec.textContent = '0';
        setDigitVisibility(fareMain, false);
        setDigitVisibility(fareDec, false);
        extrasMain.textContent = '0.';
        extrasDec.textContent = '0';
        setDigitVisibility(extrasMain, false);
        setDigitVisibility(extrasDec, false);
      } else {
        const fare = formatFare(state.fare);
        fareMain.textContent = fare.main;
        fareDec.textContent = fare.dec;
        setDigitVisibility(fareMain, true);
        setDigitVisibility(fareDec, true);
        if (state.extras === 0) {
          extrasMain.textContent = '0.';
          extrasDec.textContent = '0';
          setDigitVisibility(extrasMain, false);
          setDigitVisibility(extrasDec, false);
        } else {
          const extras = formatFare(state.extras);
          extrasMain.textContent = extras.main;
          extrasDec.textContent = extras.dec;
          setDigitVisibility(extrasMain, true);
          setDigitVisibility(extrasDec, true);
        }
      }

      mileageIndicator.classList.toggle('active', state.running);

      updateStatusIndicators();
    }

    function updateTimeDisplay() {
      const elapsed = state.running
        ? state.elapsedBeforePause + (Date.now() - state.startTime)
        : state.elapsedBeforePause;
      const totalSec = Math.floor(elapsed / 1000);
      const min = Math.floor(totalSec / 60).toString().padStart(2, '0');
      const sec = (totalSec % 60).toString().padStart(2, '0');
      timeInfo.textContent = `${min}:${sec}`;
      distanceInfo.textContent = (state.distanceM / 1000).toFixed(3) + ' km';
    }

    // === GPS ===
    function startGPS() {
      if (!navigator.geolocation) {
        gpsText.textContent = 'No GPS';
        gpsDot.classList.add('error');
        return;
      }

      state.watchId = navigator.geolocation.watchPosition(
        (pos) => {
          gpsDot.classList.add('active');
          gpsDot.classList.remove('error');
          state.gpsAvailable = true;

          if (!state.running) return;

          const now = Date.now();
          const speed = pos.coords.speed !== null ? pos.coords.speed : 0;

          if (state.lastPosition) {
            const dist = haversine(
              state.lastPosition.lat, state.lastPosition.lng,
              pos.coords.latitude, pos.coords.longitude
            );

            // Filter out GPS jitter — ignore tiny movements with low accuracy
            const accuracy = pos.coords.accuracy || 100;
            if (dist > Math.max(2, accuracy * 0.3)) {
              const prevDistance = state.distanceM;
              state.distanceM += dist;

              // Only count distance beyond the starting allowance toward fare ticks
              if (state.distanceM > STARTING_DISTANCE) {
                const chargeableNew = dist - Math.max(0, STARTING_DISTANCE - prevDistance);
                state.distanceSinceLastTick += chargeableNew;
              }
              state.isMoving = true;
            } else if (speed < state.speedThreshold) {
              state.isMoving = false;
            }
          }

          state.lastPosition = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
          };
          state.lastTimestamp = now;

          // Check distance-based fare
          while (state.distanceSinceLastTick >= DISTANCE_INCREMENT) {
            state.fare += FARE_PER_INCREMENT;
            state.distanceSinceLastTick -= DISTANCE_INCREMENT;
            onFareTick();
          }

          updateDisplay();
          updateTimeDisplay();
          saveRide();
        },
        (err) => {
          gpsDot.classList.remove('active');
          gpsDot.classList.add('error');
          gpsText.textContent = 'GPS err';
          console.warn('GPS error:', err.message);
        },
        {
          enableHighAccuracy: true,
          maximumAge: 1000,
          timeout: 5000,
        }
      );
    }

    function stopGPS() {
      if (state.watchId !== null) {
        navigator.geolocation.clearWatch(state.watchId);
        state.watchId = null;
      }
    }

    // === Haversine distance (meters) ===
    function haversine(lat1, lng1, lat2, lng2) {
      const R = 6371000;
      const toRad = (d) => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLng/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // === Stationary timer ===
    function startStationaryTimer() {
      let lastCheck = Date.now();
      state.timerInterval = setInterval(() => {
        if (!state.running) return;
        const now = Date.now();
        const dt = now - lastCheck;
        lastCheck = now;

        // If not moving, accumulate stationary time
        if (!state.isMoving) {
          state.stationaryMs += dt;
          state.stationarySinceLastTick += dt;

          while (state.stationarySinceLastTick >= TIME_INCREMENT) {
            state.fare += FARE_PER_INCREMENT;
            state.stationarySinceLastTick -= TIME_INCREMENT;
            onFareTick();
          }
        }

        updateDisplay();
        updateTimeDisplay();
        saveRide();
      }, 500);
    }

    function stopStationaryTimer() {
      if (state.timerInterval) {
        clearInterval(state.timerInterval);
        state.timerInterval = null;
      }
    }

    // === Controls ===
    function startMeter() {
      if (state.running) return;
      state.running = true;
      state.paused = false;

      // If fresh start (fare is 0), set starting fare
      if (state.fare === 0) {
        state.fare = STARTING_FARE;
      }

      state.startTime = Date.now();
      state.isMoving = false;
      // status updated via updateStatusIndicators()
      updateStatusIndicators();

      startGPS();
      startStationaryTimer();
      updateDisplay();
      saveRide();
    }

    function pauseMeter() {
      if (!state.running) return;
      state.running = false;
      state.paused = true;
      state.elapsedBeforePause += (Date.now() - state.startTime);

      stopGPS();
      stopStationaryTimer();
      state.lastPosition = null;
      updateStatusIndicators();
      updateDisplay();
      saveRide();
    }

    function resetMeter() {
      // Stop everything first
      if (state.running) {
        state.running = false;
        stopGPS();
        stopStationaryTimer();
        state.lastPosition = null;
      }

      state.paused = false;
      state.fare = 0;
      state.extras = 0;
      state.totalExtras = 0;
      state.distanceM = 0;
      state.stationaryMs = 0;
      state.distanceSinceLastTick = 0;
      state.stationarySinceLastTick = 0;
      state.elapsedBeforePause = 0;
      state.lastPosition = null;
      state.lastTimestamp = null;
      state.isMoving = false;

      // status updated via updateStatusIndicators()
      updateStatusIndicators();
      updateDisplay();
      updateTimeDisplay();
      clearSavedRide();
    }

    function addExtra(amount) {
      state.extras += amount;
      state.totalExtras += amount;
      updateDisplay();
      saveRide();
    }

    // === Button bindings ===
    // "For Hire" — only resets when paused
    document.getElementById('btn-forhire').addEventListener('click', () => {
      beep();
      if (state.paused) {
        resetMeter();
      }
    });

    // "Hired" — starts the meter or resumes from pause
    document.getElementById('btn-hired').addEventListener('click', () => {
      beep();
      if (!state.running) {
        const wasVacant = !state.paused; // fresh hire vs resume from pause
        startMeter();
        if (wasVacant && ttsLang !== 'off') {
          const plateLetters = 'DL';
          const plateDigits = '9667';
          if (ttsLang === 'yue') {
            const spokenDigits = plateDigits.split('').join(' ');
            speakText('歡迎乘搭本的士 ' + plateLetters + ' ' + spokenDigits + ', 請扣好安全帶', 'zh-HK');
          } else {
            const spokenDigits = plateDigits.split('').join(' ');
            speakText('Welcome to my taxi ' + plateLetters + ' ' + spokenDigits + ', please wear your seatbelt', 'en-US');
          }
        }
      }
    });

    // Pause button: click = pause/merge, double-click = speak, triple-click = print
    // Uses delayed resolution — waits for click window to close before deciding action.
    (function() {
      const btnPause = document.getElementById('btn-pause');
      let clickCount = 0;
      let resolveTimer = null;
      let wasPausedBeforeClick = false;
      const CLICK_WINDOW = 400; // ms to wait for additional clicks

      function resolveClicks() {
        const count = clickCount;
        clickCount = 0;
        resolveTimer = null;

        // Only act on clicks that happened while already stopped
        if (!wasPausedBeforeClick) return;

        if (count >= 3) {
          // Triple-click — print receipt
          showPrintOverlay();
        } else if (count === 2) {
          // Double-click — announce fare
          if (ttsLang !== 'off') speakFare();
        } else if (count === 1 && state.extras > 0) {
          // Single click while already stopped — merge extras
          state.fare += state.extras;
          state.extras = 0;
          updateDisplay();
          saveRide();
        }
      }

      btnPause.addEventListener('click', () => {
        // On first click of a new sequence, record whether we were already paused
        if (clickCount === 0) {
          wasPausedBeforeClick = state.paused;
        }
        clickCount++;

        // If not paused, immediately pause on first click and beep
        if (!state.paused && clickCount === 1) {
          beep();
          pauseMeter();
          // Announce arrival when transitioning from HIRED → STOP
          if (ttsLang !== 'off') {
            const total = Math.round((state.fare + state.extras) * 10) / 10;
            if (ttsLang === 'yue') {
              speakText('你已經到達目的地，總車費係' + total + '蚊，已包括附加費', 'zh-HK');
            } else {
              speakText('You have reached the destination, the total fare is ' + total + ' dollars, including surcharge', 'en-US');
            }
          }
        }
        // No beep when already stopped

        // Reset the resolve timer on each click
        if (resolveTimer) clearTimeout(resolveTimer);
        resolveTimer = setTimeout(resolveClicks, CLICK_WINDOW);
      });
    })();
    document.getElementById('btn-lang').addEventListener('click', () => {
      beep();
      if (ttsLang === 'off') {
        ttsLang = 'yue';
      } else if (ttsLang === 'yue') {
        ttsLang = 'en';
      } else {
        ttsLang = 'off';
      }
      statusLangEn.classList.toggle('active', ttsLang === 'en');
      statusLangYue.classList.toggle('active', ttsLang === 'yue');
    });
    // Hold-to-subtract logic for extras buttons
    function setupExtrasButton(btnId, amount) {
      const btn = document.getElementById(btnId);
      let holdTimer = null;
      let repeatInterval = null;
      let held = false;

      function subtractOnce() {
        if (state.extras > 0) {
          beep();
          const actual = Math.min(amount, state.extras);
          state.extras = Math.max(0, state.extras - amount);
          state.totalExtras = Math.max(0, state.totalExtras - actual);
          updateDisplay();
          saveRide();
        }
      }

      function onDown(e) {
        e.preventDefault();
        held = false;
        holdTimer = setTimeout(() => {
          held = true;
          subtractOnce();
          repeatInterval = setInterval(() => {
            subtractOnce();
          }, 1000);
        }, 500);
      }

      function stopHold() {
        if (holdTimer) {
          clearTimeout(holdTimer);
          holdTimer = null;
        }
        if (repeatInterval) {
          clearInterval(repeatInterval);
          repeatInterval = null;
        }
      }

      function onUp(e) {
        e.preventDefault();
        stopHold();
        if (!held) {
          beep();
          addExtra(amount);
        }
      }

      function onCancel() {
        stopHold();
      }

      btn.addEventListener('mousedown', onDown);
      btn.addEventListener('mouseup', onUp);
      btn.addEventListener('mouseleave', onCancel);
      btn.addEventListener('touchstart', onDown, { passive: false });
      btn.addEventListener('touchend', onUp, { passive: false });
      btn.addEventListener('touchcancel', onCancel);
    }

    setupExtrasButton('btn-add10', 10);
    setupExtrasButton('btn-add1', 1);

    // === Init ===
    // Restore saved ride if any
    (function restoreSavedRide() {
      const saved = loadRide();
      if (saved && saved.fare > 0) {
        state.fare = saved.fare;
        state.extras = saved.extras || 0;
        state.totalExtras = saved.totalExtras || 0;
        state.distanceM = saved.distanceM || 0;
        state.stationaryMs = saved.stationaryMs || 0;
        state.distanceSinceLastTick = saved.distanceSinceLastTick || 0;
        state.stationarySinceLastTick = saved.stationarySinceLastTick || 0;

        // Account for time elapsed while the page was closed
        const timeSinceSave = Date.now() - (saved.savedAt || Date.now());
        state.elapsedBeforePause = (saved.elapsedMs || 0) + (saved.wasRunning ? timeSinceSave : 0);

        // Show HIRED label since there's an active ride
        // status updated via updateStatusIndicators()

        // Resume in paused state so user can review and press HIRED
        state.running = false;
        state.paused = true;
      }
    })();

    updateDisplay();
    updateTimeDisplay();
    updateStatusIndicators();

    // Attempt initial GPS check
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        () => {
          gpsDot.classList.add('active');
          state.gpsAvailable = true;
        },
        () => {
          gpsDot.classList.add('error');
          gpsText.textContent = 'GPS N/A';
        },
        { timeout: 3000 }
      );
    }
    // === Receipt Printer ===
    function cjkWidth(str) {
      let w = 0;
      for (const ch of str) {
        w += ch.charCodeAt(0) > 0x7F ? 2 : 1;
      }
      return w;
    }

    function centerLine(text, width) {
      const tw = cjkWidth(text);
      const pad = Math.max(0, Math.floor((width - tw) / 2));
      return ' '.repeat(pad) + text;
    }

    function receiptLine(cn, en, val, width, engCol) {
      const cnW = cjkWidth(cn);
      const enGap = ' '.repeat(Math.max(1, engCol - cnW));
      const left = cn + enGap + en;
      const leftW = cjkWidth(left);
      const valW = cjkWidth(val);
      const rightGap = ' '.repeat(Math.max(1, width - leftW - valW));
      return left + rightGap + val;
    }

    function generateReceiptText() {
      const total = Math.round((state.fare + state.extras) * 10) / 10;
      const elapsed = state.elapsedBeforePause;
      const distKm = (state.distanceM / 1000).toFixed(2);
      const paidKm = Math.max(0, (state.distanceM - STARTING_DISTANCE) / 1000).toFixed(2);
      const paidMin = (state.stationaryMs / 60000).toFixed(2);

      const pad2 = n => n.toString().padStart(2, '0');
      const fmtDT = d => pad2(d.getDate()) + '/' + pad2(d.getMonth() + 1) + '/' + d.getFullYear() + ' ' + pad2(d.getHours()) + ':' + pad2(d.getMinutes());

      const endTime = new Date();
      const startTime = new Date(endTime.getTime() - elapsed);

      const W = 34;
      const EC = 9; // English column start
      const rl = (cn, en, val) => receiptLine(cn, en, val, W, EC);

      const div = '='.repeat(W);
      const dash = '-'.repeat(W);

      const lines = [
        rl('車牌', 'TAXI NO.', 'DL9667'),
        rl('上車', 'START', fmtDT(startTime)),
        rl('下車', 'END', fmtDT(endTime)),
        rl('總公里', 'TOTAL KM', distKm),
        rl('收費公里', 'PAID KM', paidKm),
        rl('收費分鐘', 'PAID MIN', paidMin),
        rl('附加費', 'SURCHARGE', 'HK$' + state.totalExtras.toFixed(2)),
        rl('總車費', 'TOTAL FARE', 'HK$' + total.toFixed(2)),
      ];

      return lines.join('\n');
    }

    // Dot-matrix stepper: feed paper in lurching steps like a real printer
    function dotMatrixFeed(paperTrack, contentEl, onComplete) {
      // Measure final height needed
      paperTrack.style.maxHeight = 'none';
      const targetHeight = paperTrack.scrollHeight;
      paperTrack.style.maxHeight = '0';

      // Force reflow
      paperTrack.offsetHeight;

      paperTrack.classList.add('printing');

      let currentHeight = 0;
      // Each "line" step is roughly one line of receipt text height
      const lineHeight = 17; // ~px per line
      const totalSteps = Math.ceil(targetHeight / lineHeight);
      let step = 0;

      function feedStep() {
        if (step >= totalSteps) {
          paperTrack.style.maxHeight = targetHeight + 'px';
          // Printing done — call completion handler
          if (onComplete) setTimeout(onComplete, 300);
          return;
        }

        step++;
        currentHeight = Math.min(step * lineHeight, targetHeight);
        paperTrack.style.maxHeight = currentHeight + 'px';

        // Dot-matrix rhythm: quick advance, then brief pause
        // Vary timing slightly for realism
        const moveTime = 30 + Math.random() * 20;
        const pauseTime = 80 + Math.random() * 60;

        setTimeout(() => {
          // Small intermediate micro-step for the "chug" feel
          const microStep = Math.min(currentHeight + lineHeight * 0.3, targetHeight);
          paperTrack.style.maxHeight = microStep + 'px';
          setTimeout(feedStep, pauseTime);
        }, moveTime);
      }

      // Initial delay before first step
      setTimeout(feedStep, 200);
    }

    function showPrintOverlay() {
      const overlay = document.getElementById('printer-overlay');
      const paperTrack = overlay.querySelector('.printer-paper-track');
      const receiptContent = document.getElementById('receipt-content');
      const paper = document.getElementById('receipt-paper');
      const scene = overlay.querySelector('.printer-scene');

      // Generate receipt
      receiptContent.textContent = generateReceiptText();

      // Reset state
      receiptCanvas = null;
      paperTrack.classList.remove('printing');
      paperTrack.style.maxHeight = '0';
      paper.classList.remove('tearing', 'presented');
      paper.style.transform = '';
      paper.style.opacity = '';
      paper.style.transition = '';
      scene.classList.remove('entered', 'printer-exit');

      // Ensure paper is back in the paper track
      if (paper.parentElement !== paperTrack) paperTrack.appendChild(paper);
      overlay.classList.remove('hidden');

      // Trigger printer slide-in from bottom
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          scene.classList.add('entered');
        });
      });

      // Start dot-matrix paper feed after printer enters
      setTimeout(() => {
        printSound.currentTime = 0;
        printSound.play();
        dotMatrixFeed(paperTrack, receiptContent, () => {
          printSound.pause();
          printSound.currentTime = 0;
          // Step 1: Snap to fixed center but keep rotateY(89deg) — no visual change
          paper.style.transition = 'none';
          paper.classList.add('presented');
          paper.style.transform = 'translate(-50%, -50%) rotateY(89deg)';
          paper.offsetHeight; // force reflow

          // Reparent to overlay (no visual jump — already fixed-positioned)
          overlay.appendChild(paper);

          // Step 2: Animate the swing to face user + slide printer out
          requestAnimationFrame(() => {
            paper.style.transition = '';
            paper.style.transform = ''; // reverts to .presented CSS: rotateY(0deg)
            scene.classList.add('printer-exit');

            // Capture receipt image once swing animation completes (~800ms)
            setTimeout(captureReceipt, 900);
          });
        });
      }, 600);
    }

    function hidePrintOverlay() {
      const overlay = document.getElementById('printer-overlay');
      const paperTrack = overlay.querySelector('.printer-paper-track');
      const paper = document.getElementById('receipt-paper');
      const scene = overlay.querySelector('.printer-scene');

      // Put paper back into the paper track for next print
      paperTrack.appendChild(paper);

      paperTrack.classList.remove('printing');
      paperTrack.style.maxHeight = '0';
      paper.classList.remove('presented', 'tearing');
      paper.style.transform = '';
      paper.style.transition = '';
      scene.classList.remove('entered', 'printer-exit');

      overlay.classList.add('hidden');
    }

    function getReceiptFilename() {
      const plate = 'DL9667';
      const elapsed = state.elapsedBeforePause;
      const startTime = new Date(Date.now() - elapsed);
      const pad2 = n => n.toString().padStart(2, '0');
      const dt = startTime.getFullYear()
        + pad2(startTime.getMonth() + 1)
        + pad2(startTime.getDate())
        + '-'
        + pad2(startTime.getHours())
        + pad2(startTime.getMinutes());
      return 'receipt-' + plate + '-' + dt + '.png';
    }

    // Pre-capture receipt as canvas while it's still visible, store for sharing later
    let receiptCanvas = null;

    function captureReceipt() {
      const paper = document.getElementById('receipt-paper');

      // Clone the paper off-screen with no transforms so html2canvas renders it flat
      const clone = paper.cloneNode(true);
      clone.style.position = 'fixed';
      clone.style.left = '-9999px';
      clone.style.top = '0';
      clone.style.transform = 'none';
      clone.style.width = paper.offsetWidth + 'px';
      clone.style.zIndex = '-1';
      document.body.appendChild(clone);

      html2canvas(clone, {
        backgroundColor: '#f5f0e8',
        scale: 2,
      }).then(function(canvas) {
        receiptCanvas = canvas;
        document.body.removeChild(clone);
      }).catch(function() {
        document.body.removeChild(clone);
      });
    }

    function shareReceipt() {
      if (!receiptCanvas) return;
      const filename = getReceiptFilename();

      receiptCanvas.toBlob(function(blob) {
        if (navigator.share && navigator.canShare) {
          const file = new File([blob], filename, { type: 'image/png' });
          if (navigator.canShare({ files: [file] })) {
            navigator.share({ files: [file], title: 'HK Taxi Receipt' }).catch(function() {});
            return;
          }
        }
        // Fallback: download
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 'image/png');
    }

    // Tear-off gesture — free-form drag, follows finger, flies off on release
    (function setupTearGesture() {
      const paper = document.getElementById('receipt-paper');
      let startX = 0, startY = 0;
      let currentX = 0, currentY = 0;
      let dragging = false;

      function onStart(e) {
        // Only allow tear after paper is presented (printed + centered)
        if (!paper.classList.contains('presented')) return;

        const touch = e.touches ? e.touches[0] : e;
        startX = touch.clientX;
        startY = touch.clientY;
        currentX = startX;
        currentY = startY;
        dragging = true;
        paper.style.transition = 'none';
      }

      function onMove(e) {
        if (!dragging) return;
        e.preventDefault();
        const touch = e.touches ? e.touches[0] : e;
        currentX = touch.clientX;
        currentY = touch.clientY;
        const dx = currentX - startX;
        const dy = currentY - startY;

        // Include the -50%,-50% centering offset so paper doesn't jump
        const rotation = dx * 0.04;
        paper.style.transform = 'translate(calc(-50% + ' + dx + 'px), calc(-50% + ' + dy + 'px)) rotate(' + rotation + 'deg)';
      }

      function onEnd() {
        if (!dragging) return;
        dragging = false;
        const dx = currentX - startX;
        const dy = currentY - startY;
        const dist = Math.sqrt(dx * dx + dy * dy);

        if (dist > 80) {
          // Play tear sound
          tearSound.currentTime = 0;
          tearSound.play();
          // Fly off in the direction of the drag
          const angle = Math.atan2(dy, dx);
          const flyDist = 600;
          const flyX = Math.cos(angle) * flyDist;
          const flyY = Math.sin(angle) * flyDist;
          const flyRotation = dx * 0.06;

          paper.style.transition = 'transform 0.35s ease-in';
          paper.style.transform = 'translate(calc(-50% + ' + flyX + 'px), calc(-50% + ' + flyY + 'px)) rotate(' + flyRotation + 'deg)';

          // Share receipt image
          shareReceipt();

          // Fade out backdrop while receipt flies away
          const backdrop = document.querySelector('.printer-overlay-backdrop');
          backdrop.classList.add('fading');

          setTimeout(() => {
            paper.style.transform = '';
            paper.style.transition = '';
            backdrop.classList.remove('fading');
            hidePrintOverlay();
          }, 500);
        } else {
          // Snap back to center
          paper.style.transition = 'transform 0.3s';
          paper.style.transform = '';
        }
      }

      paper.addEventListener('touchstart', onStart, { passive: false });
      paper.addEventListener('touchmove', onMove, { passive: false });
      paper.addEventListener('touchend', onEnd);
      paper.addEventListener('mousedown', onStart);
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onEnd);
    })();

  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#111111">
  <link rel="manifest" href="manifest.json">
  <title>HK Taxi Meter</title>
  <style>
    @font-face {
      font-family: 'DSEG7';
      src: url('https://cdn.jsdelivr.net/npm/dseg@0.46.0/fonts/DSEG7-Classic/DSEG7Classic-Bold.woff2') format('woff2'),
           url('https://cdn.jsdelivr.net/npm/dseg@0.46.0/fonts/DSEG7-Classic/DSEG7Classic-Bold.woff') format('woff');
      font-weight: bold;
      font-style: normal;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #1a1a1a;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      font-family: Arial, Helvetica, sans-serif;
    }

    .meter {
      background: #111;
      border: 3px solid #333;
      border-radius: 8px;
      width: 520px;
      padding: 0;
      box-shadow: 0 4px 20px rgba(0,0,0,0.8), inset 0 1px 0 rgba(255,255,255,0.05);
      overflow: hidden;
    }

    /* Top display area */
    .display-area {
      background: #0a0a0a;
      border: 2px solid #222;
      margin: 12px 12px 0 12px;
      padding: 10px 14px 0;
      position: relative;
    }

    .display-row {
      display: flex;
      align-items: stretch;
      gap: 0;
    }

    .fare-section, .extras-section {
      flex: 1;
      position: relative;
      border: 1.5px solid #555;
      padding: 8px 0 14px 10px;
    }

    .fare-section {
      margin-right: 2px;
    }

    .section-label {
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      background: #0a0a0a;
      padding: 0 8px;
      color: #ccc;
      font-size: 11px;
      font-weight: bold;
      letter-spacing: 3px;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .brand-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4px 6px 4px 20px;
      color: #888;
      font-size: 8px;
      line-height: 1.3;
      text-align: center;
    }

    .brand-area .brand-logo {
      font-size: 10px;
      font-weight: bold;
      color: #aaa;
      border: 1px solid #888;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 2px;
    }

    .brand-area .brand-name {
      font-weight: bold;
      font-size: 9px;
      color: #aaa;
    }

    .brand-area .brand-model {
      font-size: 8px;
      color: #777;
    }

    .digit-display {
      position: relative;
      min-height: 48px;
      display: flex;
      align-items: flex-end;
      justify-content: flex-end;
    }

    .digit-main, .digit-decimal {
      position: relative;
    }

    .digit-decimal {
      border-left: 1.5px solid #555;
      margin-left: 5px;
      padding-left: 1px;
    }

    .seven-seg, .seven-seg-bg {
      font-family: 'DSEG7', monospace;
      font-size: 40px;
      letter-spacing: 2px;
      line-height: 1;
    }

    .digit-main .seven-seg-bg, .digit-decimal .seven-seg-bg {
      position: absolute;
      right: 0;
      bottom: 0;
    }

    .seven-seg {
      color: #ff1a1a;
      text-shadow: 0 0 12px rgba(255, 20, 20, 0.6), 0 0 24px rgba(255, 20, 20, 0.3);
    }

    .seven-seg-bg {
      color: rgba(255, 20, 20, 0.07);
    }

    .currency-label {
      position: absolute;
      bottom: -7px;
      left: 33%;
      background: #0a0a0a;
      padding: 0 4px;
      color: #ccc;
      font-size: 11px;
      font-weight: bold;
    }

    .unit-label {
      position: absolute;
      bottom: -7px;
      right: 0;
      background: #0a0a0a;
      padding: 0 4px;
      color: #ccc;
      font-size: 11px;
      font-weight: bold;
    }

    .status-row {
      display: flex;
      margin: 6px 0;
      justify-content: center;
      align-items: center;
      padding: 0 8px;
    }

    .status-cell {
      width: 52px;
      margin: 0 6px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 14px;
    }

    .status-text {
      font-family: 'Arial Narrow', 'Helvetica Neue', sans-serif;
      font-stretch: condensed;
      font-size: 12px;
      font-weight: bold;
      color: transparent;
      text-transform: uppercase;
      letter-spacing: 0;
    }

    .status-text.active {
      color: #ff1a1a;
      text-shadow: 0 0 12px rgba(255, 20, 20, 0.6), 0 0 24px rgba(255, 20, 20, 0.3);
    }

    .mileage-indicator {
      width: 20px;
      height: 10px;
      background: #332200;
      border-radius: 1px;
    }

    .mileage-indicator.active {
      background: #ffaa00;
      box-shadow: 0 0 6px rgba(255, 170, 0, 0.6);
    }

    /* Bottom control panel */
    .control-panel {
      background: #1a1a1a;
      border-top: 2px solid #222;
      margin: 8px 12px 12px;
      padding: 10px 8px;
      display: flex;
      gap: 0;
      justify-content: center;
      align-items: flex-end;
      position: relative;
    }


    .meter-btn {
      width: 52px;
      height: 28px;
      border: 1px solid #222;
      border-radius: 3px;
      cursor: pointer;
      position: relative;
      margin: 0 6px;
      outline: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.1);
      transition: transform 0.05s, box-shadow 0.05s;
    }

    .meter-btn:active {
      transform: translateY(1px);
      box-shadow: 0 1px 2px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.05);
    }

    .btn-red {
      background: linear-gradient(180deg, #cc3333 0%, #991111 100%);
    }

    .btn-yellow {
      background: linear-gradient(180deg, #ccaa33 0%, #998811 100%);
    }

    .btn-orange {
      background: linear-gradient(180deg, #cc7733 0%, #995511 100%);
    }

    .btn-label {
      font-size: 7px;
      color: #999;
      text-align: center;
      margin-bottom: 3px;
      white-space: nowrap;
      height: 11px;
      line-height: 11px;
    }

    .btn-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* GPS status */
    .gps-status {
      font-size: 9px;
      color: #555;
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .gps-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: #333;
    }

    .gps-dot.active {
      background: #00cc44;
      box-shadow: 0 0 4px rgba(0, 204, 68, 0.5);
    }

    .gps-dot.error {
      background: #cc3333;
    }

    /* Distance info at bottom */
    .debug-info {
      margin: 0 12px 8px;
      padding: 4px 8px;
      font-size: 9px;
      color: #444;
      display: flex;
      justify-content: space-between;
    }

    /* Portrait phone */
    @media (max-width: 560px) and (orientation: portrait) {
      .meter {
        width: 100vw;
        border-radius: 0;
        border-left: none;
        border-right: none;
      }
      .seven-seg, .seven-seg-bg {
        font-size: 32px;
      }
      .brand-area {
      }
    }

    /* Landscape phone — full bleed, no chrome */
    @media (max-height: 500px) and (orientation: landscape) {
      html, body {
        height: 100%;
        overflow: hidden;
      }

      body {
        align-items: stretch;
      }

      .meter {
        width: 100vw;
        height: 100vh;
        height: 100dvh;
        border: none;
        border-radius: 0;
        box-shadow: none;
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
      }

      .display-row {
        width: 100%;
      }

      .fare-section, .extras-section {
        padding: 12px 0 16px 16px;
      }

      .seven-seg, .seven-seg-bg {
        font-size: clamp(46px, 11.4vw, 76px);
      }

      .section-label {
        font-size: 14px;
        letter-spacing: 4px;
        top: -10px;
        padding: 0 10px;
      }

      .currency-label {
        font-size: 14px;
        bottom: -9px;
        left: 10px;
      }

      .unit-label {
        font-size: 14px;
        bottom: -9px;
        right: 10px;
      }

      .brand-area {
        font-size: 10px;
      }

      .brand-area .brand-logo {
        width: 36px;
        height: 36px;
        font-size: 14px;
      }

      .brand-area .brand-name {
        font-size: 12px;
      }

      .brand-area .brand-model {
        font-size: 10px;
      }

      .status-cell {
        width: 80px;
        margin: 0 12px;
        height: 18px;
      }

      .status-text {
        font-size: 16px;
      }

      .mileage-indicator {
        width: 28px;
        height: 14px;
      }


      .control-panel {
        margin: 4px 12px 6px;
        padding: 10px 12px;
      }

      .meter-btn {
        width: 80px;
        height: 40px;
        margin: 0 12px;
        border-radius: 4px;
      }

      .btn-label {
        font-size: 16px;
        margin-bottom: 4px;
        height: 18px;
        line-height: 18px;
      }

      .debug-info {
        margin: 0 16px 6px;
        padding: 4px 12px;
        font-size: 11px;
      }

      .gps-status {
        font-size: 11px;
      }

      .gps-dot {
        width: 7px;
        height: 7px;
      }
    }
    /* === Receipt Printer Overlay === */
    .printer-overlay {
      position: fixed;
      inset: 0;
      z-index: 1000;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 60px;
    }
    .printer-overlay.hidden { display: none; }

    .printer-overlay-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.88);
    }

    .printer-scene {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Paper track sits ABOVE the printer, clipped */
    .printer-paper-track {
      width: 250px;
      position: relative;
      z-index: 1;
      overflow: hidden;
      max-height: 0;
    }

    .printer-paper-track.printing {
      animation: paper-feed 3s ease-out forwards;
    }

    @keyframes paper-feed {
      from { max-height: 0; }
      to   { max-height: 650px; }
    }

    .receipt-paper {
      background: #f5f0e8;
      width: 100%;
      padding: 0;
      position: relative;
      cursor: grab;
    }

    .receipt-paper:active { cursor: grabbing; }

    .receipt-content {
      font-family: 'Courier New', 'Courier', monospace;
      font-size: 11px;
      line-height: 1.55;
      color: #222;
      white-space: pre;
      padding: 14px 10px 8px;
    }

    .receipt-tear-edge {
      height: 10px;
      width: 100%;
      background: #f5f0e8;
      clip-path: polygon(
        0% 0%, 2.5% 100%, 5% 0%, 7.5% 100%, 10% 0%, 12.5% 100%,
        15% 0%, 17.5% 100%, 20% 0%, 22.5% 100%, 25% 0%, 27.5% 100%,
        30% 0%, 32.5% 100%, 35% 0%, 37.5% 100%, 40% 0%, 42.5% 100%,
        45% 0%, 47.5% 100%, 50% 0%, 52.5% 100%, 55% 0%, 57.5% 100%,
        60% 0%, 62.5% 100%, 65% 0%, 67.5% 100%, 70% 0%, 72.5% 100%,
        75% 0%, 77.5% 100%, 80% 0%, 82.5% 100%, 85% 0%, 87.5% 100%,
        90% 0%, 92.5% 100%, 95% 0%, 97.5% 100%, 100% 0%
      );
    }

    .receipt-tear-hint {
      text-align: center;
      color: #999;
      font-size: 11px;
      margin-top: 16px;
      position: relative;
      z-index: 3;
      animation: hint-pulse 2s ease-in-out infinite;
    }

    @keyframes hint-pulse {
      0%, 100% { opacity: 0.5; transform: translateY(0); }
      50% { opacity: 1; transform: translateY(-4px); }
    }

    .receipt-paper.tearing {
      animation: tear-away 0.4s ease-in forwards;
    }

    @keyframes tear-away {
      0%   { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(-150px) rotate(-4deg); opacity: 0; }
    }

    /* Printer body — realistic thermal printer */
    .printer-body {
      width: 300px;
      height: 100px;
      background: linear-gradient(180deg, #333 0%, #222 30%, #1a1a1a 70%, #151515 100%);
      border-radius: 16px 16px 12px 12px;
      position: relative;
      z-index: 2;
      box-shadow:
        0 6px 24px rgba(0,0,0,0.7),
        0 2px 6px rgba(0,0,0,0.5),
        inset 0 1px 0 rgba(255,255,255,0.1),
        inset 0 -1px 0 rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .printer-top-edge {
      width: 100%;
      height: 8px;
      background: linear-gradient(180deg, #444 0%, #333 100%);
      border-radius: 16px 16px 0 0;
    }

    .printer-face {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      position: relative;
    }

    .printer-slot {
      width: 258px;
      height: 5px;
      background: #000;
      border-radius: 2px;
      position: absolute;
      top: -2px;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.9), 0 1px 0 rgba(255,255,255,0.05);
    }

    .printer-logo {
      font-size: 12px;
      font-weight: bold;
      color: #555;
      border: 1.5px solid #555;
      border-radius: 50%;
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 8px;
    }

    .printer-brand {
      font-size: 8px;
      color: #444;
      font-weight: bold;
      margin-top: 2px;
      letter-spacing: 2px;
    }

    .printer-led {
      position: absolute;
      top: 14px;
      right: 24px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #00cc44;
      box-shadow: 0 0 6px rgba(0,204,68,0.6);
      animation: led-blink 1s ease-in-out infinite;
    }

    @keyframes led-blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .printer-close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1001;
      background: none;
      border: none;
      color: #666;
      font-size: 28px;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* === Receipt Full View === */
    .receipt-view {
      position: fixed;
      inset: 0;
      z-index: 1002;
      background: rgba(0,0,0,0.92);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .receipt-view.hidden { display: none; }

    .receipt-final {
      background: #f5f0e8;
      padding: 20px 14px;
      max-width: 360px;
      width: 100%;
      font-family: 'Courier New', 'Courier', monospace;
      font-size: 12px;
      line-height: 1.55;
      color: #222;
      white-space: pre;
      text-align: center;
      box-shadow: 0 8px 40px rgba(0,0,0,0.5);
      max-height: 70vh;
      overflow-y: auto;
    }

    .receipt-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .receipt-action-btn {
      padding: 12px 28px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      background: #cc3333;
      color: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .receipt-action-btn.secondary {
      background: #444;
      color: #ccc;
    }

    /* Responsive: portrait phone */
    @media (max-width: 560px) and (orientation: portrait) {
      .printer-body { width: 270px; height: 90px; }
      .printer-slot { width: 232px; }
      .printer-paper-track { width: 224px; }
      .receipt-content { font-size: 10px; }
      .printer-overlay { padding-bottom: 30px; }
    }
  </style>
</head>
<body>
  <div class="meter">
    <div class="display-area">
      <div class="display-row">
        <div class="fare-section">
          <div class="section-label">F A R E</div>
          <div class="digit-display">
            <div class="digit-main">
              <span class="seven-seg-bg">888.</span>
              <span class="seven-seg" id="fare-main">0.</span>
            </div>
            <div class="digit-decimal">
              <span class="seven-seg-bg">8</span>
              <span class="seven-seg" id="fare-dec">0</span>
            </div>
          </div>
          <div class="currency-label">HK$</div>
          <div class="unit-label">C(x10)</div>
        </div>
        <div class="extras-section">
          <div class="section-label">EXTRAS</div>
          <div class="digit-display">
            <div class="digit-main">
              <span class="seven-seg-bg">888.</span>
              <span class="seven-seg" id="extras-main">0.</span>
            </div>
            <div class="digit-decimal">
              <span class="seven-seg-bg">8</span>
              <span class="seven-seg" id="extras-dec">0</span>
            </div>
          </div>
          <div class="currency-label">HK$</div>
          <div class="unit-label">C(x10)</div>
        </div>
        <div class="brand-area">
          <div class="brand-logo">D</div>
          <div class="brand-name">DLLM</div>
          <div class="brand-model">DLM 667</div>
          <div class="brand-model">P K</div>
        </div>
      </div>
      <div class="status-row">
        <div class="status-cell"><span class="status-text" id="status-vacant">VACANT</span></div>
        <div class="status-cell"><span class="status-text" id="status-hired">HIRED</span></div>
        <div class="status-cell"><span class="status-text" id="status-stop">STOP</span></div>
        <div class="status-cell status-cell-lang"><span class="status-text status-lang" id="status-lang-en">英</span><span class="status-text status-lang" id="status-lang-yue">粵</span></div>
        <div class="status-cell" style="margin-left: 16px;"><div class="mileage-indicator" id="mileage-indicator"></div></div>
        <div class="status-cell"></div>
      </div>
    </div>

    <div class="control-panel">
      <div class="btn-wrapper">
        <div class="btn-label">空</div>
        <button class="meter-btn btn-red" id="btn-forhire" title="For Hire"></button>
      </div>
      <div class="btn-wrapper">
        <div class="btn-label">往</div>
        <button class="meter-btn btn-yellow" id="btn-hired" title="Hired"></button>
      </div>
      <div class="btn-wrapper">
        <div class="btn-label">停/講/印</div>
        <button class="meter-btn btn-yellow" id="btn-pause" title="Pause"></button>
      </div>
      <div class="btn-wrapper">
        <div class="btn-label">語</div>
        <button class="meter-btn btn-yellow" id="btn-lang" title="Language"></button>
      </div>
      <div class="btn-wrapper" style="margin-left: 16px;">
        <div class="btn-label">附加 $10.</div>
        <button class="meter-btn btn-yellow" id="btn-add10" title="Add $10 Extra"></button>
      </div>
      <div class="btn-wrapper">
        <div class="btn-label">$1.</div>
        <button class="meter-btn btn-yellow" id="btn-add1" title="Add $1 Extra"></button>
      </div>
    </div>

    <div class="debug-info">
      <span class="gps-status">
        <span class="gps-dot" id="gps-dot"></span>
        <span id="gps-text">GPS</span>
      </span>
      <span id="distance-info">0.000 km</span>
      <span id="time-info">00:00</span>
    </div>
  </div>

  <!-- Printer Overlay -->
  <div id="printer-overlay" class="printer-overlay hidden">
    <div class="printer-overlay-backdrop"></div>
    <div class="printer-scene">
      <div class="printer-paper-track">
        <div id="receipt-paper" class="receipt-paper">
          <div id="receipt-content" class="receipt-content"></div>
          <div class="receipt-tear-edge"></div>
        </div>
      </div>
      <div class="printer-body">
        <div class="printer-top-edge"></div>
        <div class="printer-face">
          <div class="printer-slot"></div>
          <div class="printer-logo">D</div>
          <div class="printer-brand">DLLM</div>
          <div class="printer-led"></div>
        </div>
      </div>
      <div class="receipt-tear-hint" id="tear-hint" style="display:none;">&#8593; Swipe up to tear receipt</div>
    </div>
    <button id="printer-close" class="printer-close-btn">&times;</button>
  </div>

  <!-- Full-screen receipt view (after tear) -->
  <div id="receipt-view" class="receipt-view hidden">
    <div id="receipt-final" class="receipt-final"></div>
    <div class="receipt-actions">
      <button id="btn-save-receipt" class="receipt-action-btn">Save Image</button>
      <button id="btn-close-receipt" class="receipt-action-btn secondary">Close</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    // === Beep ===
    const beepSound = new Audio('beep.mp3');
    beepSound.volume = 0.5;
    function beep() {
      beepSound.currentTime = 0;
      beepSound.play();
    }

    // === TTS ===
    let ttsLang = 'yue'; // 'yue' for Cantonese, 'en' for English

    function speakFare() {
      const total = Math.round((state.fare + state.extras) * 10) / 10;
      const dollars = Math.floor(total);
      const cents = Math.round((total - dollars) * 10); // tenths = 角/dime

      let text, lang;
      if (ttsLang === 'yue') {
        text = '現在車費是' + dollars + '元';
        if (cents > 0) text += cents + '角';
        lang = 'zh-HK';
      } else {
        text = 'The current fare is ' + dollars + ' dollar' + (dollars !== 1 ? 's' : '');
        if (cents > 0) text += ' and ' + (cents * 10) + ' cent' + (cents * 10 !== 1 ? 's' : '');
        lang = 'en-US';
      }

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = lang;
      speechSynthesis.cancel();
      speechSynthesis.speak(utterance);
    }

    // === Mileage indicator blink ===
    function blinkMileageIndicator() {
      const el = document.getElementById('mileage-indicator');
      el.classList.remove('active');
      setTimeout(() => {
        if (state.running) el.classList.add('active');
      }, 200);
    }

    function onFareTick() {
      beep();
      blinkMileageIndicator();
    }

    // === State ===
    const state = {
      running: false,
      paused: false,   // true when trip is paused (not reset)
      fare: 0,        // in HK$ (cents precision internally)
      extras: 0,       // in HK$
      distanceM: 0,    // meters traveled
      stationaryMs: 0, // milliseconds stationary
      distanceSinceLastTick: 0, // meters since last fare increment
      stationarySinceLastTick: 0, // ms since last stationary tick
      lastPosition: null,
      lastTimestamp: null,
      watchId: null,
      timerInterval: null,
      startTime: null,
      elapsedBeforePause: 0,
      gpsAvailable: false,
      isMoving: false,
      speedThreshold: 0.5, // m/s — below this we consider stationary
    };

    // === Fare rules ===
    const STARTING_FARE = 29.0;
    const STARTING_DISTANCE = 2000;  // meters included in starting fare
    const DISTANCE_INCREMENT = 200;  // meters per fare tick after starting distance
    const TIME_INCREMENT = 60000;    // 1 minute in ms
    const FARE_PER_INCREMENT = 2.1;

    // === LocalStorage keys ===
    const STORAGE_KEY_RIDE = 'hktaxi_current_ride';
    const STORAGE_KEY_LOG = 'hktaxi_fare_log'; // for future fare history

    // === Persistence ===
    function saveRide() {
      try {
        const elapsed = state.running
          ? state.elapsedBeforePause + (Date.now() - state.startTime)
          : state.elapsedBeforePause;
        const data = {
          fare: state.fare,
          extras: state.extras,
          distanceM: state.distanceM,
          stationaryMs: state.stationaryMs,
          distanceSinceLastTick: state.distanceSinceLastTick,
          stationarySinceLastTick: state.stationarySinceLastTick,
          elapsedMs: elapsed,
          wasRunning: state.running,
          savedAt: Date.now(),
        };
        localStorage.setItem(STORAGE_KEY_RIDE, JSON.stringify(data));
      } catch (e) {
        // Storage full or unavailable — silently ignore
      }
    }

    function loadRide() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_RIDE);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (e) {
        return null;
      }
    }

    function clearSavedRide() {
      try { localStorage.removeItem(STORAGE_KEY_RIDE); } catch (e) {}
    }

    // === DOM refs ===
    const fareMain = document.getElementById('fare-main');
    const fareDec = document.getElementById('fare-dec');
    const extrasMain = document.getElementById('extras-main');
    const extrasDec = document.getElementById('extras-dec');
    const mileageIndicator = document.getElementById('mileage-indicator');
    const statusVacant = document.getElementById('status-vacant');
    const statusHired = document.getElementById('status-hired');
    const statusStop = document.getElementById('status-stop');
    const statusLangEn = document.getElementById('status-lang-en');
    const statusLangYue = document.getElementById('status-lang-yue');
    let langIndicatorState = 'default'; // 'default' (no light), 'en', 'yue'
    const gpsDot = document.getElementById('gps-dot');
    const gpsText = document.getElementById('gps-text');
    const distanceInfo = document.getElementById('distance-info');
    const timeInfo = document.getElementById('time-info');

    // === Display formatting ===
    function formatFare(amount) {
      const rounded = Math.round(amount * 10) / 10;
      const str = rounded.toFixed(1);
      const dotIdx = str.indexOf('.');
      return {
        main: str.substring(0, dotIdx + 1),  // e.g. "29."
        dec: str.substring(dotIdx + 1),       // e.g. "0"
      };
    }

    function updateStatusIndicators() {
      const isVacant = !state.running && !state.paused;
      const isHired = state.running;
      const isStop = !state.running && state.paused;

      statusVacant.classList.toggle('active', isVacant);
      statusHired.classList.toggle('active', isHired);
      statusStop.classList.toggle('active', isStop);
    }

    function setDigitVisibility(el, visible) {
      el.style.visibility = visible ? 'visible' : 'hidden';
    }

    function updateDisplay() {
      const isVacant = !state.running && !state.paused;

      if (isVacant && state.fare === 0) {
        // Hide digits when vacant (keep layout via seven-seg text)
        fareMain.textContent = '0.';
        fareDec.textContent = '0';
        setDigitVisibility(fareMain, false);
        setDigitVisibility(fareDec, false);
        extrasMain.textContent = '0.';
        extrasDec.textContent = '0';
        setDigitVisibility(extrasMain, false);
        setDigitVisibility(extrasDec, false);
      } else {
        const fare = formatFare(state.fare);
        fareMain.textContent = fare.main;
        fareDec.textContent = fare.dec;
        setDigitVisibility(fareMain, true);
        setDigitVisibility(fareDec, true);
        if (state.extras === 0) {
          extrasMain.textContent = '0.';
          extrasDec.textContent = '0';
          setDigitVisibility(extrasMain, false);
          setDigitVisibility(extrasDec, false);
        } else {
          const extras = formatFare(state.extras);
          extrasMain.textContent = extras.main;
          extrasDec.textContent = extras.dec;
          setDigitVisibility(extrasMain, true);
          setDigitVisibility(extrasDec, true);
        }
      }

      mileageIndicator.classList.toggle('active', state.running);

      updateStatusIndicators();
    }

    function updateTimeDisplay() {
      const elapsed = state.running
        ? state.elapsedBeforePause + (Date.now() - state.startTime)
        : state.elapsedBeforePause;
      const totalSec = Math.floor(elapsed / 1000);
      const min = Math.floor(totalSec / 60).toString().padStart(2, '0');
      const sec = (totalSec % 60).toString().padStart(2, '0');
      timeInfo.textContent = `${min}:${sec}`;
      distanceInfo.textContent = (state.distanceM / 1000).toFixed(3) + ' km';
    }

    // === GPS ===
    function startGPS() {
      if (!navigator.geolocation) {
        gpsText.textContent = 'No GPS';
        gpsDot.classList.add('error');
        return;
      }

      state.watchId = navigator.geolocation.watchPosition(
        (pos) => {
          gpsDot.classList.add('active');
          gpsDot.classList.remove('error');
          state.gpsAvailable = true;

          if (!state.running) return;

          const now = Date.now();
          const speed = pos.coords.speed !== null ? pos.coords.speed : 0;

          if (state.lastPosition) {
            const dist = haversine(
              state.lastPosition.lat, state.lastPosition.lng,
              pos.coords.latitude, pos.coords.longitude
            );

            // Filter out GPS jitter — ignore tiny movements with low accuracy
            const accuracy = pos.coords.accuracy || 100;
            if (dist > Math.max(2, accuracy * 0.3)) {
              const prevDistance = state.distanceM;
              state.distanceM += dist;

              // Only count distance beyond the starting allowance toward fare ticks
              if (state.distanceM > STARTING_DISTANCE) {
                const chargeableNew = dist - Math.max(0, STARTING_DISTANCE - prevDistance);
                state.distanceSinceLastTick += chargeableNew;
              }
              state.isMoving = true;
            } else if (speed < state.speedThreshold) {
              state.isMoving = false;
            }
          }

          state.lastPosition = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
          };
          state.lastTimestamp = now;

          // Check distance-based fare
          while (state.distanceSinceLastTick >= DISTANCE_INCREMENT) {
            state.fare += FARE_PER_INCREMENT;
            state.distanceSinceLastTick -= DISTANCE_INCREMENT;
            onFareTick();
          }

          updateDisplay();
          updateTimeDisplay();
          saveRide();
        },
        (err) => {
          gpsDot.classList.remove('active');
          gpsDot.classList.add('error');
          gpsText.textContent = 'GPS err';
          console.warn('GPS error:', err.message);
        },
        {
          enableHighAccuracy: true,
          maximumAge: 1000,
          timeout: 5000,
        }
      );
    }

    function stopGPS() {
      if (state.watchId !== null) {
        navigator.geolocation.clearWatch(state.watchId);
        state.watchId = null;
      }
    }

    // === Haversine distance (meters) ===
    function haversine(lat1, lng1, lat2, lng2) {
      const R = 6371000;
      const toRad = (d) => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLng = toRad(lng2 - lng1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLng/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // === Stationary timer ===
    function startStationaryTimer() {
      let lastCheck = Date.now();
      state.timerInterval = setInterval(() => {
        if (!state.running) return;
        const now = Date.now();
        const dt = now - lastCheck;
        lastCheck = now;

        // If not moving, accumulate stationary time
        if (!state.isMoving) {
          state.stationaryMs += dt;
          state.stationarySinceLastTick += dt;

          while (state.stationarySinceLastTick >= TIME_INCREMENT) {
            state.fare += FARE_PER_INCREMENT;
            state.stationarySinceLastTick -= TIME_INCREMENT;
            onFareTick();
          }
        }

        updateDisplay();
        updateTimeDisplay();
        saveRide();
      }, 500);
    }

    function stopStationaryTimer() {
      if (state.timerInterval) {
        clearInterval(state.timerInterval);
        state.timerInterval = null;
      }
    }

    // === Controls ===
    function startMeter() {
      if (state.running) return;
      state.running = true;
      state.paused = false;

      // If fresh start (fare is 0), set starting fare
      if (state.fare === 0) {
        state.fare = STARTING_FARE;
      }

      state.startTime = Date.now();
      state.isMoving = false;
      // status updated via updateStatusIndicators()
      updateStatusIndicators();

      startGPS();
      startStationaryTimer();
      updateDisplay();
      saveRide();
    }

    function pauseMeter() {
      if (!state.running) return;
      state.running = false;
      state.paused = true;
      state.elapsedBeforePause += (Date.now() - state.startTime);

      stopGPS();
      stopStationaryTimer();
      state.lastPosition = null;
      updateStatusIndicators();
      updateDisplay();
      saveRide();
    }

    function resetMeter() {
      // Stop everything first
      if (state.running) {
        state.running = false;
        stopGPS();
        stopStationaryTimer();
        state.lastPosition = null;
      }

      state.paused = false;
      state.fare = 0;
      state.extras = 0;
      state.distanceM = 0;
      state.stationaryMs = 0;
      state.distanceSinceLastTick = 0;
      state.stationarySinceLastTick = 0;
      state.elapsedBeforePause = 0;
      state.lastPosition = null;
      state.lastTimestamp = null;
      state.isMoving = false;

      // status updated via updateStatusIndicators()
      updateStatusIndicators();
      updateDisplay();
      updateTimeDisplay();
      clearSavedRide();
    }

    function addExtra(amount) {
      state.extras += amount;
      updateDisplay();
      saveRide();
    }

    // === Button bindings ===
    // "For Hire" — only resets when paused
    document.getElementById('btn-forhire').addEventListener('click', () => {
      beep();
      if (state.paused) {
        resetMeter();
      }
    });

    // "Hired" — starts the meter or resumes from pause
    document.getElementById('btn-hired').addEventListener('click', () => {
      beep();
      if (!state.running) {
        startMeter();
      }
    });

    // Pause button: click = pause/merge, double-click = speak, triple-click = print
    (function() {
      const btnPause = document.getElementById('btn-pause');
      let clickTimes = [];

      btnPause.addEventListener('click', () => {
        beep();
        const now = Date.now();
        // Keep only clicks within 500ms window
        clickTimes = clickTimes.filter(t => now - t < 500);
        clickTimes.push(now);

        if (state.paused && clickTimes.length >= 3) {
          // Triple-click while stopped — print receipt
          clickTimes = [];
          showPrintOverlay();
        } else if (state.paused && clickTimes.length === 2) {
          // Double-click while stopped — announce fare
          speakFare();
        } else if (state.paused && clickTimes.length === 1 && state.extras > 0) {
          // Single click while stopped — merge extras
          setTimeout(() => {
            // Only merge if no further clicks came
            if (clickTimes.length === 1) {
              state.fare += state.extras;
              state.extras = 0;
              updateDisplay();
              saveRide();
            }
          }, 500);
        } else if (!state.paused) {
          pauseMeter();
        }
      });
    })();
    document.getElementById('btn-lang').addEventListener('click', () => {
      beep();
      if (langIndicatorState === 'default') {
        langIndicatorState = 'en';
        ttsLang = 'en';
      } else if (langIndicatorState === 'en') {
        langIndicatorState = 'yue';
        ttsLang = 'yue';
      } else {
        langIndicatorState = 'en';
        ttsLang = 'en';
      }
      statusLangEn.classList.toggle('active', langIndicatorState === 'en');
      statusLangYue.classList.toggle('active', langIndicatorState === 'yue');
    });
    // Hold-to-subtract logic for extras buttons
    function setupExtrasButton(btnId, amount) {
      const btn = document.getElementById(btnId);
      let holdTimer = null;
      let repeatInterval = null;
      let held = false;

      function subtractOnce() {
        if (state.extras > 0) {
          beep();
          state.extras = Math.max(0, state.extras - amount);
          updateDisplay();
          saveRide();
        }
      }

      function onDown(e) {
        e.preventDefault();
        held = false;
        holdTimer = setTimeout(() => {
          held = true;
          subtractOnce();
          repeatInterval = setInterval(() => {
            subtractOnce();
          }, 1000);
        }, 500);
      }

      function stopHold() {
        if (holdTimer) {
          clearTimeout(holdTimer);
          holdTimer = null;
        }
        if (repeatInterval) {
          clearInterval(repeatInterval);
          repeatInterval = null;
        }
      }

      function onUp(e) {
        e.preventDefault();
        stopHold();
        if (!held) {
          beep();
          addExtra(amount);
        }
      }

      function onCancel() {
        stopHold();
      }

      btn.addEventListener('mousedown', onDown);
      btn.addEventListener('mouseup', onUp);
      btn.addEventListener('mouseleave', onCancel);
      btn.addEventListener('touchstart', onDown, { passive: false });
      btn.addEventListener('touchend', onUp, { passive: false });
      btn.addEventListener('touchcancel', onCancel);
    }

    setupExtrasButton('btn-add10', 10);
    setupExtrasButton('btn-add1', 1);

    // === Init ===
    // Restore saved ride if any
    (function restoreSavedRide() {
      const saved = loadRide();
      if (saved && saved.fare > 0) {
        state.fare = saved.fare;
        state.extras = saved.extras || 0;
        state.distanceM = saved.distanceM || 0;
        state.stationaryMs = saved.stationaryMs || 0;
        state.distanceSinceLastTick = saved.distanceSinceLastTick || 0;
        state.stationarySinceLastTick = saved.stationarySinceLastTick || 0;

        // Account for time elapsed while the page was closed
        const timeSinceSave = Date.now() - (saved.savedAt || Date.now());
        state.elapsedBeforePause = (saved.elapsedMs || 0) + (saved.wasRunning ? timeSinceSave : 0);

        // Show HIRED label since there's an active ride
        // status updated via updateStatusIndicators()

        // Resume in paused state so user can review and press HIRED
        state.running = false;
        state.paused = true;
      }
    })();

    updateDisplay();
    updateTimeDisplay();
    updateStatusIndicators();

    // Attempt initial GPS check
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        () => {
          gpsDot.classList.add('active');
          state.gpsAvailable = true;
        },
        () => {
          gpsDot.classList.add('error');
          gpsText.textContent = 'GPS N/A';
        },
        { timeout: 3000 }
      );
    }
    // === Receipt Printer ===
    function cjkWidth(str) {
      let w = 0;
      for (const ch of str) {
        w += ch.charCodeAt(0) > 0x7F ? 2 : 1;
      }
      return w;
    }

    function centerLine(text, width) {
      const tw = cjkWidth(text);
      const pad = Math.max(0, Math.floor((width - tw) / 2));
      return ' '.repeat(pad) + text;
    }

    function receiptLine(cn, en, val, width, engCol) {
      const cnW = cjkWidth(cn);
      const enGap = ' '.repeat(Math.max(1, engCol - cnW));
      const left = cn + enGap + en;
      const leftW = cjkWidth(left);
      const valW = cjkWidth(val);
      const rightGap = ' '.repeat(Math.max(1, width - leftW - valW));
      return left + rightGap + val;
    }

    function generateReceiptText() {
      const total = Math.round((state.fare + state.extras) * 10) / 10;
      const elapsed = state.elapsedBeforePause;
      const distKm = (state.distanceM / 1000).toFixed(2);
      const paidKm = Math.max(0, (state.distanceM - STARTING_DISTANCE) / 1000).toFixed(2);
      const paidMin = (state.stationaryMs / 60000).toFixed(2);

      const pad2 = n => n.toString().padStart(2, '0');
      const fmtDT = d => pad2(d.getDate()) + '/' + pad2(d.getMonth() + 1) + '/' + d.getFullYear() + ' ' + pad2(d.getHours()) + ':' + pad2(d.getMinutes());

      const endTime = new Date();
      const startTime = new Date(endTime.getTime() - elapsed);

      const W = 34;
      const EC = 9; // English column start
      const rl = (cn, en, val) => receiptLine(cn, en, val, W, EC);

      const div = '='.repeat(W);
      const dash = '-'.repeat(W);

      const lines = [
        div,
        centerLine('的士收據', W),
        centerLine('TAXI RECEIPT', W),
        div,
        rl('車牌', 'TAXI NO.', 'DL9667'),
        dash,
        rl('上車', 'Start', fmtDT(startTime)),
        rl('下車', 'END', fmtDT(endTime)),
        dash,
        rl('總公里', 'TOTAL KM', distKm),
        rl('收費公里', 'PAID KM', paidKm),
        rl('收費分鐘', 'PAID MIN', paidMin),
        dash,
        rl('附加費', 'SURCHARGE', 'HK$' + state.extras.toFixed(2)),
        rl('總車費', 'TOTAL FARE', 'HK$' + total.toFixed(2)),
        div,
        '',
        centerLine('多謝乘搭', W),
        centerLine('Thank you', W),
        div,
      ];

      return lines.join('\n');
    }

    function showPrintOverlay() {
      const overlay = document.getElementById('printer-overlay');
      const paperTrack = overlay.querySelector('.printer-paper-track');
      const receiptContent = document.getElementById('receipt-content');
      const paper = document.getElementById('receipt-paper');
      const tearHint = document.getElementById('tear-hint');

      // Generate receipt
      receiptContent.textContent = generateReceiptText();

      // Reset state
      paperTrack.classList.remove('printing');
      paperTrack.style.maxHeight = '0';
      paper.classList.remove('tearing');
      paper.style.transform = '';
      paper.style.opacity = '';
      paper.style.transition = '';
      tearHint.style.display = 'none';
      overlay.classList.remove('hidden');

      // Start paper feed after brief delay
      setTimeout(() => {
        paperTrack.classList.add('printing');
      }, 300);

      // Show tear hint after paper finishes printing
      setTimeout(() => {
        tearHint.style.display = 'block';
      }, 3400);
    }

    function hidePrintOverlay() {
      const overlay = document.getElementById('printer-overlay');
      const paperTrack = overlay.querySelector('.printer-paper-track');
      paperTrack.classList.remove('printing');
      paperTrack.style.maxHeight = '0';
      document.getElementById('tear-hint').style.display = 'none';
      overlay.classList.add('hidden');
    }

    function showReceiptView() {
      const view = document.getElementById('receipt-view');
      const finalEl = document.getElementById('receipt-final');
      finalEl.textContent = generateReceiptText();
      view.classList.remove('hidden');
    }

    function hideReceiptView() {
      document.getElementById('receipt-view').classList.add('hidden');
    }

    function saveReceiptAsImage() {
      const finalEl = document.getElementById('receipt-final');
      html2canvas(finalEl, {
        backgroundColor: '#f5f0e8',
        scale: 2,
      }).then(function(canvas) {
        canvas.toBlob(function(blob) {
          if (navigator.share && navigator.canShare) {
            const file = new File([blob], 'hk-taxi-receipt.png', { type: 'image/png' });
            if (navigator.canShare({ files: [file] })) {
              navigator.share({ files: [file], title: 'HK Taxi Receipt' }).catch(function() {
                downloadBlob(blob);
              });
              return;
            }
          }
          downloadBlob(blob);
        }, 'image/png');
      });
    }

    function downloadBlob(blob) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'hk-taxi-receipt.png';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Tear-off gesture
    (function setupTearGesture() {
      const paper = document.getElementById('receipt-paper');
      let startY = 0;
      let currentY = 0;
      let dragging = false;

      function onStart(e) {
        // Only allow tear after paper is fully printed
        const paperTrack = paper.closest('.printer-paper-track');
        if (!paperTrack.classList.contains('printing')) return;

        const touch = e.touches ? e.touches[0] : e;
        startY = touch.clientY;
        currentY = startY;
        dragging = true;
        paper.style.transition = 'none';
      }

      function onMove(e) {
        if (!dragging) return;
        e.preventDefault();
        const touch = e.touches ? e.touches[0] : e;
        currentY = touch.clientY;
        const dy = currentY - startY;

        if (dy < 0) {
          const clamped = Math.max(dy, -160);
          paper.style.transform = 'translateY(' + clamped + 'px) rotate(' + (clamped * 0.02) + 'deg)';
          paper.style.opacity = String(1 + (clamped / 220));
        }
      }

      function onEnd() {
        if (!dragging) return;
        dragging = false;
        const dy = currentY - startY;

        if (dy < -80) {
          // Tear off!
          paper.classList.add('tearing');
          paper.addEventListener('animationend', function handler() {
            paper.removeEventListener('animationend', handler);
            hidePrintOverlay();
            paper.classList.remove('tearing');
            paper.style.transform = '';
            paper.style.opacity = '';
            paper.style.transition = '';
            showReceiptView();
          });
        } else {
          // Snap back
          paper.style.transition = 'transform 0.3s, opacity 0.3s';
          paper.style.transform = '';
          paper.style.opacity = '';
        }
      }

      paper.addEventListener('touchstart', onStart, { passive: false });
      paper.addEventListener('touchmove', onMove, { passive: false });
      paper.addEventListener('touchend', onEnd);
      paper.addEventListener('mousedown', onStart);
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onEnd);
    })();

    // Receipt button bindings
    document.getElementById('printer-close').addEventListener('click', hidePrintOverlay);
    document.getElementById('btn-save-receipt').addEventListener('click', saveReceiptAsImage);
    document.getElementById('btn-close-receipt').addEventListener('click', hideReceiptView);
  </script>
</body>
</html>
